#!/usr/bin/env python
from reuss import ReceiverServer, getch
from argparse import ArgumentParser
import multiprocessing as mp
import time
import signal

def handler(signum, frame):
    print("hey", flush=True)


parser = ArgumentParser()
parser.add_argument(
    "-p",
    "--port",
    help="TCP control port",
    type=int,
    default=5556,
)
signal.signal(signal.SIGINT, handler)
args = parser.parse_args()
r = ReceiverServer(f"tcp://*:{args.port}")
p = mp.Process(target=r.run, args=(),)
p.start()

time.sleep(0.1)
while True:
    ch = getch()
    if ch == 'q' or ch == '\x03':
        r.stop()
        break
    time.sleep(0.1)
p.join()
